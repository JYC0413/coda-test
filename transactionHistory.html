<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>transaction history</title>
    <link href="./dist/css/index.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="module" src="component/TransactionTab.js"></script>
    <script type="module" src="component/Selector.js"></script>
    <link href="./dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<a href="home.html">
    <div style="margin-top: 1.2rem;margin-left: 1.2rem;padding: 0.8rem;border: 1px solid var(--base-green);width: min-content;border-radius: 50%">
        <img src="media/Back.svg">
    </div>
</a>
<div style="text-align: center">
    Transaction History
    <img style="margin-left: 2rem;position: absolute;width: 2rem;display: none;" src="media/Export.svg">
</div>
<div style="padding: 1.2rem;">
    <div id="title" style="display: flex;justify-content: space-between;align-items: center;">
        <div id="distributed" style="display: flex;flex-wrap: wrap;justify-content: end;">
        </div>
        <div id="redeemed" style="display: flex;flex-wrap: wrap;justify-content: end;">
        </div>
    </div>
    <div style="height: 1px;background-color: #ADA9A9;margin: 0.7rem 0"></div>
    <div id="history-place"></div>
</div>
<script>
    const historyPlace = document.getElementById("history-place")
    const distributedPlace = document.getElementById("distributed")
    const timeSelector = document.createElement("select-component")
    const redeemedPlace = document.getElementById("redeemed")
    let transactionData = []
    let distributed = 0
    let redeemed = 0

    function formatDate(date) {
        if (!date) {
            date = new Date();
        }
        const month = date.toLocaleString('en', {month: 'short'});
        const year = date.getFullYear();
        return month + " " + year
    }

    let current = new Date();
    let startMonth = 11;
    let currentMonth = current.getMonth() + 1;
    let startYear = 2023;
    let currentYear = current.getFullYear();

    timeSelector.list = []
    for (let year = startYear; year <= currentYear; year++) {
        for (let month = startMonth; month <= 12; month++) {
            if (year === currentYear && month > currentMonth) {
                break;
            }
            let displayMonth = new Date(year, month - 1).toLocaleString('en', {month: 'short'});
            let date = `${displayMonth} ${year}`;
            timeSelector.list.push(date)
        }
        startMonth = 1
    }

    function filterByMonth(monthStr) {
        historyPlace.innerHTML = ""
        transactionData.filter(item => {
            const [month, year] = monthStr.split(' ');
            const date = new Date(`${month} 1, ${year}`);
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getTime();
            const lastDay = new Date(date.getFullYear(), date.getMonth() + 1, 1).getTime() - 1;
            const differentLength = 13 - item.time.length;
            const timestamp = parseInt(item.time) * Math.pow(10, differentLength);
            return timestamp >= firstDay && timestamp < lastDay;
        }).forEach(item => {
            const comp = document.createElement('transaction-component');
            comp.img = item.img;
            comp.name = item.name;
            comp.price = item.price;
            comp.time = item.time;
            historyPlace.appendChild(comp);
        });
    }

    timeSelector.defaultValue = formatDate()
    timeSelector.type = "time"
    timeSelector.changeCallBack = filterByMonth
    const titlePart = document.getElementById("title")
    titlePart.insertBefore(timeSelector, titlePart.firstChild);

    setTimeout(() => {
        transactionData.push(
            {
                img: 'a',
                name: '商品',
                price: 19.99,
                time: '1700544246'
            }, {
                img: 'a',
                name: '商品',
                price: 5.99,
                time: '1701854367'
            }, {
                img: 'b',
                name: '商品1',
                price: 3.99,
                time: '1701535454'
            }
        )
        distributed = 200
        redeemed = 29.97
        let distributedTitle = document.createElement("div")
        distributedTitle.style.marginRight = "0.25rem"
        distributedTitle.innerText = "Distributed:"
        distributedPlace.appendChild(distributedTitle)
        let distributedValue = document.createElement("div")
        distributedValue.innerText = distributed + " SCT"
        distributedPlace.appendChild(distributedValue)
        let redeemedTitle = document.createElement("div")
        redeemedTitle.style.marginRight = "0.25rem"
        redeemedTitle.innerText = "Distributed:"
        redeemedPlace.appendChild(redeemedTitle)
        let redeemedValue = document.createElement("div")
        redeemedValue.innerText = redeemed + " SCT"
        redeemedPlace.appendChild(redeemedValue)
        filterByMonth(timeSelector.defaultValue)
    }, 2000)
</script>
</body>
</html>